name: Deployment Status

on:
  workflow_run:
    workflows: ["Deploy to EC2"]
    types:
      - completed

jobs:
  deployment-status:
    runs-on: ubuntu-latest
    steps:
      - name: Check deployment status
        uses: actions/github-script@v6
        with:
          script: |
            const workflow_run = context.payload.workflow_run;
            const conclusion = workflow_run.conclusion;
            const created_at = new Date(workflow_run.created_at).toLocaleString();
            
            const message = `
            ## éƒ¨ç½²çŠ¶æ€æ›´æ–°
            
            - éƒ¨ç½²æ—¶é—´: ${created_at}
            - çŠ¶æ€: ${conclusion === 'success' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}
            - éƒ¨ç½²åˆ†æ”¯: ${workflow_run.head_branch}
            - æäº¤ä¿¡æ¯: ${workflow_run.head_commit.message}
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.workflow_run.pull_requests[0]?.number,
              body: message
            });

      - name: Notify on failure
        if: ${{ github.event.workflow_run.conclusion == 'failure' }}
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            await github.rest.issues.create({
              owner,
              repo,
              title: 'ğŸš¨ éƒ¨ç½²å¤±è´¥è­¦å‘Š',
              body: `
              éƒ¨ç½²åœ¨ ${new Date().toLocaleString()} å¤±è´¥
              
              è¯·æŸ¥çœ‹ [éƒ¨ç½²æ—¥å¿—](${context.payload.workflow_run.html_url}) è·å–è¯¦ç»†ä¿¡æ¯ã€‚
              `
            }); 